{% extends "layouts/base.html" %}
{% block content %}
{% if result %}
{% set start_mid     = result.thread_ids[-1] %}
{% set start_subject = result.data.metadata[start_mid].subject %}
{% set profiles      = mailpile('settings', 'profiles').result.profiles %}

<div id="thread-title" class="clearfix">
  <h1>{{ start_subject }}</h1>
  <ul class="horizontal">
    <li><a class="show-thread-people" href="#"><span class="icon-user"></span> {{ result.data.addresses|length }} {{_("People")}}</a></li>
    <li><a class="show-thread-security" href="#"><span class="icon-lock-open"></span> Partially Secure</a></li>
  </ul>
</div>

<div class="bulk-actions clearfix">
  <div class="left">{{ result.data.metadata|length }} {{_("Messages")}}</div>
  <ul class="horizontal right">
<!-- FIXME
	  <li><a class="bulk-action" href="#" data-action="later" title="{{_("Move Whole Thread to Later")}}"><span class="icon-later"></span></a></li>
-->
	  <li><a class="bulk-action" href="#" data-action="assign-tags" title="{{_("Assign Tags to Thread")}}"><span class="icon-tag"></span></a></li>
	  <li><a class="bulk-action" href="#" data-action="archive" title="{{_("Archive Whole Thread")}}"><span class="icon-archive"></span></a></li>
	  <li><a class="bulk-action" href="#" data-action="trash" title="{{_("Delete Whole Thread")}}"><span class="icon-trash"></span></a></li>
  </ul>  
</div>

<div id="thread-messages">
{% for mid in result.thread_ids %}
  {% set metadata = result.data.metadata[mid] %}
  {% set message  = result.data.messages[mid] %}
  {% set from     = result.data.addresses[metadata.from_aid] %}
  {% if mid in result.data.messages %}
  {% if not message.editing_string %}

  <!-- FIXME: make subject line show differing subjects {{ metadata.subject|e }} -->    
  <div class="thread-message" id="message-{{mid}}" data-mid="{{mid}}">
    {% set show_encryption = true %}
    {% include("partials/thread_item_metadata.html") %}
    <div class="thread-item-metadata-details" id="metadata-details-{{mid}}">
    <ul>
      {% for to_aid in metadata.to_aids %}
      {% set person = result.data.addresses[to_aid] %}
      <li>
        <a href="{{ contact_url(person) }}" data-address="{{person.address}}"><img src="{{ show_avatar(person) }}"></a>
        <a href="{{ contact_url(person) }}" data-address="{{person.address}}">{{ contact_name(profiles, person) }}</a>
      </li>
      {% endfor %}
    </ul>
    </div>

    {% set last_enc_uid = message.crypto.encryption.uid %}
    {% set last_sig_uid = message.crypto.signature.uid %}
    {% for part in message.text_parts %}
      {#
       # Parts which do not have their own crypto attribute inherit from the
       # message itself.
       #}
      {% set crypto = part.crypto or message.crypto %}
      {#
       # Watch for changes to the uid which is present in each encryption and
       # signature section - if either has changed, then we have moved from
       # one security context to the next, and need to let the user know.
       #}
      {% if (part.data != "") and ((crypto.encryption.uid != last_enc_uid) or (crypto.signature.uid != last_sig_uid)) %}
      {% set last_enc_uid = crypto.encryption.uid %}
      {% set last_sig_uid = crypto.signature.uid %}
      <div class="thread-item-encryption text-part-{{ part.type }} pgp-encryption-{{ crypto.encryption.status }} clearfix">
        <div class="thread-item-encryption-info left" data-name="cats">
          {% if crypto.encryption.status in ("none", "partial-decrypted", "partial-missingkey", "partial-error") %}
          <span class="icon icon-lock-open" title="{{_("Warning: This message was not encrypted. It may have been intercepted en route to you and read by an unauthorized party.")}}"></span> <span class="text">Not Encrypted</span>
          {% endif %}
          {% if crypto.encryption.status == "decrypted" %}
          <span class="icon icon-lock-open" title="{{_("Successfully decrypted message")}}"></span> <span class="text">Encrypted</span>
          {% endif %}
          {% if crypto.encryption.status == "missingkey" %}
          <span class="icon icon-lock-error" title="{{_("You do not have any of the private keys that will decrypt this message")}}"></span> <span class="text">Missing Key</span>
          {% endif %}
          {% if crypto.encryption.status == "error" %}
          <span class="icon icon-lock-error" title="{{_("Failed to decrypt message")}}"></span> <span class="text">Error</span>
          {% endif %}
        </div>
        <div class="thread-item-encryption-line left"></div>
      </div>
      <div class="thread-item-text">{{ part.data|e|urlize }}</div>
      {% elif part.type == "text" %}
      <div class="thread-item-text">{{ part.data|e|urlize }}</div>
      {% elif part.type == "quote" %}
      <div class="thread-item-quote" id="message-quote-{{mid}}-{{loop.index}}"><div class="thread-item-quote-show" data-quote_id="{{mid}}-{{loop.index}}">&middot;&middot;&middot;&middot;</div><div class="thread-item-quote-text" id="message-quote-text-{{mid}}-{{loop.index}}">{{ part.data|e|urlize }}</div>
      </div>
      {% endif %}
    {% endfor %}
    </div>

    <div class="thread-message-attachments">
    <ul>
      {% for att in message.attachments %}
      <li>
        <a href="/message/download/={{ mid }}/part:{{ att.count }}/" type="{{ att.mimetype }}" title="{{ att.mimetype }} @ {{ att.length|friendly_bytes }}">
        {% if att.mimetype in ('image/jpg', 'image/jpeg', 'image/png', 'image/gif') %}
          <img src="/message/download/preview/={{ mid }}/part:{{ att.count }}/"><br />
        {% endif %}
          {{ att.filename }}<br />
          <small>{{ att.length|friendly_bytes }}</small>
        </a>
      </li>
      {% endfor %}
    </ul>
    </div>

    <div id="thread-message-actions" class="bulk-actions clearfix" data-mid="E36">
      <ul class="horizontal left">
        <li><a href="#"><span class="icon-forward"></span> Forward</a></li>
        <li class="dropdown">
          <a class="dropdown-toggle" data-toggle="dropdown" id="thread-message-move" href="#"><span class="icon-move"></span> Move</a>
          <ul id="menu1" class="dropdown-menu" role="menu" aria-labelledby="thread-message-move">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="#"><span class="icon-inbox"></span> Move to Inbox</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="#"><span class="icon-spam"></span> Flag as Spam</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="#"><span class="icon-circle-x"></span> Remove from Thread</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="#"></a></li>
          </ul>
        </li>
        <li><a href="#"><span class="icon-trash"></span> Trash</a></li>
      </ul>
    </div>
    {% include("partials/compose.html") %}
  {% endif %}

  {% else %}{# if not message.editing... #}

    <div class="thread-snippet" data-mid="{{ mid }}">
      {% set show_encryption = false %}
      {% include("partials/thread_item_metadata.html") %}
      <div class="thread-item-text">{{ metadata.body.snippet }}</div>
    </div>

  {% endif %}
  {% endfor %}{# for mid ... #}
</div>

<div id="thread-people">
  <h3>{{_("People in Conversation")}}</h3>
  <ul>
    {% for aid in result.data.addresses %}
    {% set person = result.data.addresses[aid] %}
    <li>
      <a href="{{ contact_url(person) }}"><img src="{{ show_avatar(person) }}"></a>
      <a href="{{ contact_url(person) }}"> {{person.fn}}</a>
      <a href=""><span class="icon-compose"></span> {{person.address}}</a>
    </li>
    {% endfor %}
  </ul>
</div>

  {% else %}
    {% set error_title = "message_missing" %}
    {% include("partials/errors_content.html") %}
  {% endif  %}{# if result #}
{% endblock %}
